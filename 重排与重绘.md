# 重排与重绘


## 一、重排（Reflow）

### 1.1 概念

当DOM的变化影响了元素的几何信息（如位置和尺寸），浏览器需要重新计算元素的几何属性，这个过程叫做**重排**。

### 1.2 触发重排的情况

- 页面初始渲染
- 添加/删除可见的DOM元素
- 改变元素位置、尺寸、内容
- 改变浏览器窗口尺寸（resize）
- 激活CSS伪类（例如：`:hover`）
- 设置`style`属性的值
- 查询某些属性或调用某些计算方法（如`offsetWidth`、`getComputedStyle`等）

### 1.3 常见引起重排的属性和方法

**盒模型相关属性**：

- `width`、`height`、`padding`、`margin`、`border`
- `display`、`border-width`、`min-height`

**定位和浮动相关**：

- `top`、`bottom`、`left`、`right`
- `position`、`float`、`clear`

**节点内容或结构相关**：

- `text-align`、`overflow`、`font-weight`、`font-family`
- `line-height`、`vertical-align`、`white-space`
- `font-size`

**获取布局信息的方法**：

- `offsetWidth`、`offsetHeight`、`offsetTop`、`offsetLeft`
- `clientWidth`、`clientHeight`、`clientTop`、`clientLeft`
- `scrollWidth`、`scrollHeight`、`scrollTop`、`scrollLeft`
- `getComputedStyle()`、`getBoundingClientRect()`
- `scrollIntoView()`、`scrollTo()`

### 1.4 重排影响的范围

- **全局范围**：从根节点`html`开始对整个渲染树进行重新布局
- **局部范围**：对渲染树的某部分或某一个渲染对象进行重新布局

> 💡 **提示**：重排是不可避免的，只能将重排对性能的影响减到最小。

## 二、重绘（Repaint）

### 2.1 概念

当一个元素的外观发生改变，但没有改变布局，重新把元素外观绘制出来的过程，叫做**重绘**。

### 2.2 常见的引起重绘的属性

**颜色相关**：

- `color`、`background`、`background-color`、`background-image`

**边框样式相关**：

- `border-style`、`border-radius`、`outline`、`outline-color`、`outline-style`、`outline-width`

**视觉效果相关**：

- `visibility`、`box-shadow`、`text-decoration`

> 💡 **注意**：重排必然会触发重绘，但重绘不一定会引发重排。

## 三、性能优化建议
回流优化方法包括：合并多次 DOM 操作、使用 DocumentFragment 批量插入节点、避免频繁读取布局属性、使用虚拟 DOM 合并更新。

重绘优化方法包括：避免频繁改变视觉样式、使用合成层（如 transform、opacity）、批量修改样式后再显示元素。实际操作中，可以先隐藏元素，批量修改后再显示，或利用 requestAnimationFrame 合理安排动画。

### 3.1 减少重排范围

#### 1. 优化HTML结构

尽量以局部布局的形式组织HTML结构，尽可能小的影响重排的范围。

#### 2. 避免使用table布局

不要使用`table`布局，可能很小的一个改动会造成整个`table`的重新布局。

不得已使用`table`时，可以设置：

```css
table-layout: auto;
/* 或者 */
table-layout: fixed;
```

这样可以让`table`一行一行地渲染，限制重排的影响范围。

### 3.2 减少重排次数

#### 1. 样式集中改变

不要频繁的操作样式，对于静态页面，可以修改类名而不是样式。

```javascript
// ❌ 不好的写法
const el = document.getElementById('test');
el.style.padding = '5px';
el.style.borderLeft = '1px';
el.style.borderRight = '2px';

// ✅ 推荐写法1：使用cssText
el.style.cssText = 'padding:5px; border-left:1px; border-right:2px;';

// ✅ 推荐写法2：修改class
el.className = 'active';
```

#### 2. 分离读写操作

DOM的多个读操作（或多个写操作），应该放在一起。不要两个读操作之间，加入一个写操作。

```javascript
// ❌ 不好的写法：读写交替，触发多次重排
div.style.left = div.offsetLeft + 1 + 'px';
div.style.top = div.offsetTop + 1 + 'px';

// ✅ 推荐写法：缓存布局信息
const curLeft = div.offsetLeft;
const curTop = div.offsetTop;
div.style.left = curLeft + 1 + 'px';
div.style.top = curTop + 1 + 'px';
```

#### 3. 将DOM离线

使用以下方法减少重排次数：

**方法一：使用`display:none`**

```javascript
const ul = document.getElementById('mylist');
ul.style.display = 'none';  // 隐藏元素（1次重排）
// ... 进行大量DOM操作
ul.style.display = 'block'; // 显示元素（1次重排）
```

**方法二：使用`DocumentFragment`**

```javascript
const fragment = document.createDocumentFragment();
for (let i = 0; i < 10; i++) {
  const li = document.createElement('li');
  li.innerHTML = 'List item ' + i;
  fragment.appendChild(li);  // 不触发重排
}
ul.appendChild(fragment);     // 只触发1次重排
```

**方法三：克隆节点**

```javascript
const old = document.getElementById('mylist');
const clone = old.cloneNode(true);
// ... 对clone进行操作
old.parentNode.replaceChild(clone, old);
```

#### 4. 使用absolute或fixed脱离文档流

对于复杂动画效果，使用`position: absolute`或`position: fixed`使元素脱离文档流，减少对其他元素的影响。

```css
.animation-element {
  position: absolute; /* 或 fixed */
  /* 这样修改该元素不会影响其他元素的布局 */
}
```

#### 5. 优化动画

- 使用`transform`和`opacity`实现动画效果（这些属性不会触发重排）
- 启用GPU加速：`will-change`、`transform: translateZ(0)`

```css
/* ✅ 推荐：使用transform，不触发重排 */
.box {
  transform: translateX(10px);
}

/* ❌ 不推荐：使用left，触发重排 */
.box {
  left: 10px;
}
```

#### 6. 使用虚拟DOM

现代框架（React、Vue）使用虚拟DOM，通过diff算法减少真实DOM操作，从而减少重排重绘。

- [掌握浏览器重绘(repaint)重排(reflow) - 前端进阶](https://juejin.cn/post/6844904083212468238)
- [CSS Triggers](https://csstriggers.com/) - 查询CSS属性触发的渲染行为
- [CSS硬件加速的好与坏](https://www.jianshu.com/p/99c1e8e0a2a7)